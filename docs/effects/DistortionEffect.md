# Distortion Effect

**Category:** Distortion
**Effect ID:** `distortion`
**Class:** `it.denzosoft.jfx2.effects.impl.DistortionEffect`

## Overview

High-gain distortion effect with pre and post tone controls. More aggressive than overdrive, with multiple clipping types including hard clipping option. Features both pre-clipping brightness control and post-clipping warmth control for maximum tonal flexibility.

## Sonic Description

Aggressive, high-gain distortion suitable for hard rock, metal, and modern tones. The Distortion effect provides significantly more gain than Overdrive or Drive (up to 100x), with three distinct clipping modes to shape harmonic content. The dual tone controls allow precise shaping before and after clipping, enabling everything from thick, scooped metal tones to cutting lead sounds.

The effect excels at sustaining power chords, aggressive palm muting, and high-gain lead work while maintaining note definition and clarity.

## Parameters

### 1. Drive
- **Range:** 1.0x to 100.0x
- **Default:** 20.0x
- **Unit:** x (linear multiplier)
- **Description:** Amount of gain and distortion. Lower values (1-10x) provide moderate overdrive. Mid values (15-40x) deliver classic high-gain distortion. Higher values (50-100x) create heavily saturated, compressed tones with maximum sustain.

### 2. Pre Tone
- **Range:** -12.0 dB to +12.0 dB
- **Default:** 0.0 dB
- **Unit:** dB (high shelf gain)
- **Description:** Adjusts high-frequency content (above 2 kHz) before clipping. Boost (+6 to +12 dB) for cutting, aggressive tone with emphasis on pick attack. Cut (-6 to -12 dB) for thicker, smoother sound with reduced harshness. This parameter significantly affects the harmonic content generated by clipping.

### 3. Post Tone
- **Range:** 500.0 Hz to 8000.0 Hz
- **Default:** 4000.0 Hz
- **Unit:** Hz (lowpass cutoff)
- **Description:** Filters the distorted signal after clipping. Lower values (500-2000 Hz) remove harshness and create warm, dark tones. Mid values (2500-5000 Hz) provide balanced presence. Higher values (5500-8000 Hz) add air and clarity, ideal for cutting through dense mixes.

### 4. Clip Type
- **Type:** Choice (0-2)
- **Default:** 0 (Soft)
- **Options:**
  - **0 - Soft:** Tanh-based soft clipping - warm, tube-like, smooth compression
  - **1 - Hard:** Hard clipping - aggressive, transistor-like, sharp transients
  - **2 - Asymmetric:** Asymmetric clipping - complex harmonics, tube-style warmth
- **Description:** Clipping style that determines harmonic character and feel.

### 5. Level
- **Range:** -20.0 dB to +6.0 dB
- **Default:** -6.0 dB
- **Unit:** dB
- **Description:** Output volume. Default is -6 dB to compensate for the high gain. Reduce further when using extreme drive settings to prevent clipping the next stage in the signal chain.

## Implementation Details

### Signal Flow

```
Input → HPF (100Hz) → Pre-Tone (High Shelf) → Clipping → Post-Tone (LPF) → Output LPF (8kHz) → Level → Output
```

### Filters

#### Input High-Pass Filter (100 Hz)
- **Type:** Butterworth highpass
- **Frequency:** 100 Hz (tighter than Overdrive/Drive for focused low-end)
- **Q:** 0.707
- **Purpose:** Removes DC offset and excessive rumble, tightens bass response for palm muting

#### Pre-Tone Filter (2 kHz High Shelf)
- **Type:** High shelf
- **Frequency:** 2000 Hz (fixed)
- **Q:** 0.707
- **Gain:** -12 dB to +12 dB (user adjustable)
- **Purpose:** Pre-clipping brightness control. Boosting emphasizes treble before distortion, creating more high-frequency harmonics. Cutting creates smoother, thicker saturation.

#### Post-Tone Filter
- **Type:** Butterworth lowpass
- **Frequency:** 500 Hz to 8000 Hz (user adjustable)
- **Q:** 0.707
- **Purpose:** Post-clipping warmth control. Removes harsh high-frequency harmonics generated by clipping.

#### Output Low-Pass Filter (8 kHz)
- **Type:** Butterworth lowpass
- **Frequency:** 8000 Hz (fixed)
- **Q:** 0.707
- **Purpose:** Final anti-aliasing and smoothing

### Clipping Algorithms

#### Soft Clipping (Type 0)
Uses `WaveShaper.tanhClip()`:
```
output = tanh(input * drive)
```
- Smooth, continuous saturation
- Symmetric compression
- Primarily odd harmonics (3rd, 5th, 7th)
- Warm, tube-like character
- Best for: Classic high-gain, smooth leads

#### Hard Clipping (Type 1)
Uses `WaveShaper.hardClip()`:
```
gained = input * drive
output = clamp(gained, -1.0, +1.0)
```
- Abrupt limiting at ±1.0
- Sharp transients preserved
- Rich harmonic content (all orders)
- Aggressive, transistor-like character
- Best for: Metal rhythm, aggressive palm muting

#### Asymmetric Clipping (Type 2)
Uses `WaveShaper.asymmetricClip()`:
```
factor = 0.8 + knee * 2.2

For positive half:
  output = (1.0 - exp(-input * factor)) * 0.95

For negative half:
  output = -1.0 + exp(input * factor * 0.8)
```
- Different compression for positive/negative peaks
- Even harmonics (2nd, 4th, 6th) + odd harmonics
- Complex, tube-like response
- Best for: Vintage high-gain, dynamic playing

### Pre-Tone Implementation

The Pre-Tone control uses a high shelf filter at 2 kHz:
- **Boost (+12 dB):** Emphasizes frequencies above 2 kHz before clipping
  - More pick attack and definition
  - Increased high-frequency harmonics
  - Brighter, more aggressive tone
- **Unity (0 dB):** Neutral frequency response
- **Cut (-12 dB):** Reduces frequencies above 2 kHz before clipping
  - Smoother, less harsh saturation
  - Reduced high-frequency harmonics
  - Warmer, thicker tone

## Signal Flow Diagram

```
                      ┌─────────────┐
Input ──────────────>│  HPF 100Hz  │
                      └──────┬──────┘
                             │
                      ┌──────▼──────────┐
                      │   Pre-Tone      │ (High Shelf 2kHz)
                      │ (-12 to +12 dB) │
                      └──────┬──────────┘
                             │
                      ┌──────▼──────────┐
                      │  Clipping Stage │
                      │  • Soft (tanh)  │
                      │  • Hard (clip)  │
                      │  • Asymmetric   │
                      │  (Drive param)  │
                      └──────┬──────────┘
                             │
                      ┌──────▼──────┐
                      │  Post-Tone  │ (LPF 500-8000 Hz)
                      └──────┬──────┘
                             │
                      ┌──────▼──────┐
                      │ Output LPF  │ (8 kHz)
                      └──────┬──────┘
                             │
                      ┌──────▼──────┐
                      │    Level    │
                      └──────┬──────┘
                             │
                           Output
```

## Usage Tips

### Modern Metal Rhythm
- **Drive:** 40-60x
- **Pre Tone:** -3 to 0 dB (tight, not harsh)
- **Post Tone:** 3000-4000 Hz
- **Clip Type:** Hard (1)
- **Level:** -9 to -6 dB
- **Use:** Tight palm muting, aggressive power chords

### Vintage High-Gain Lead
- **Drive:** 25-40x
- **Pre Tone:** +3 to +6 dB (cutting presence)
- **Post Tone:** 3500-5000 Hz
- **Clip Type:** Asymmetric (2)
- **Level:** -6 to -3 dB
- **Use:** Smooth, singing sustain with warmth

### Heavy Rhythm (Scooped)
- **Drive:** 50-80x
- **Pre Tone:** +6 to +9 dB (bright attack)
- **Post Tone:** 2500-3500 Hz (mid scoop)
- **Clip Type:** Hard (1)
- **Level:** -12 to -9 dB
- **Use:** Brutal, scooped metal tone

### Thick Lead
- **Drive:** 30-50x
- **Pre Tone:** -6 to -3 dB (warm)
- **Post Tone:** 2000-3000 Hz
- **Clip Type:** Soft (0)
- **Level:** -6 dB
- **Use:** Full, sustained lead with body

### Cutting Solo
- **Drive:** 20-35x
- **Pre Tone:** +9 to +12 dB (maximum presence)
- **Post Tone:** 5000-7000 Hz (bright)
- **Clip Type:** Soft (0)
- **Level:** -3 to 0 dB
- **Use:** Cuts through dense mix, articulate

### Classic Hard Rock
- **Drive:** 15-30x
- **Pre Tone:** 0 to +3 dB (balanced)
- **Post Tone:** 3500-4500 Hz
- **Clip Type:** Asymmetric (2)
- **Level:** -6 to -3 dB
- **Use:** Vintage Marshall-style crunch

## Comparison with Other Distortion Effects

| Feature | Distortion | Overdrive | Drive | Fuzz |
|---------|------------|-----------|-------|------|
| Gain range | 1-100x | 1-50x | 1-30 | 1-100 |
| Clipping types | 3 selectable | 1 (tanh) | 1 (asymmetric) | Multi-stage |
| Tone controls | 2 (pre/post) | 1 (post) | 1 (post) | 1 (post) + type |
| Harmonics | Selectable | Odd | Even | Complex |
| Character | Aggressive | Smooth | Warm | Fuzzy |
| Input HPF | 100 Hz | 80 Hz | 60 Hz | 40 Hz |
| Best for | Metal, high-gain | Classic rock | Blues, rock | Psych, stoner |
| Default level | -6 dB | 0 dB | 0 dB | -3 dB |

## Technical Notes

### Clipping Type Characteristics

**Soft (Tanh):**
- Smooth transition to saturation
- Progressive compression
- Warm, musical character
- Similar to tube overdrive
- CPU: Fast (native tanh function)

**Hard:**
- Abrupt clipping at threshold
- Preserves transients until limiting
- Aggressive, transistor-like
- Rich harmonic spectrum
- CPU: Very fast (simple clamping)

**Asymmetric:**
- Different positive/negative behavior
- Complex harmonic structure
- Tube-like warmth
- Dynamic response
- CPU: Moderate (exponential calculations)

### Pre-Tone vs Post-Tone

**Pre-Tone (High Shelf at 2 kHz):**
- Affects harmonic generation
- Changes saturation character
- More dramatic tonal impact
- Subtle changes have large effect

**Post-Tone (Lowpass):**
- Only filters harmonics
- Does not affect generation
- Subtractive shaping
- Controls brightness/harshness

### Implementation Details
- Stereo processing: Independent left/right channels
- No latency introduced
- 8 biquad filters total per channel (4 per side in stereo)
- Filter states reset on bypass
- Dynamic parameter updates smoothed
- CPU usage: Low to moderate depending on clipping type

### Recommended Signal Chain Position
Place Distortion after:
- Wah, envelope filters
- Compressor (optional, for controlled input)
- EQ (for pre-shaping)

Place Distortion before:
- Modulation (chorus, flanger, phaser)
- Delay
- Reverb
- EQ (for post-shaping)
